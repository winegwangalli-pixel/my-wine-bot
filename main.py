import streamlit as st
import google.generativeai as genai
import pandas as pd

# 1. λ³΄μ• μ„¤μ •
try:
    GOOGLE_API_KEY = st.secrets["GEMINI_API_KEY"]
    genai.configure(api_key=GOOGLE_API_KEY)
except Exception as e:
    st.error("API ν‚¤ μ„¤μ •μ— λ¬Έμ κ°€ μμµλ‹λ‹¤. Streamlit Secretsλ¥Ό ν™•μΈν•΄μ£Όμ„Έμ”.")
    st.stop()

# 2. λ°μ΄ν„° λ΅λ“
SHEET_ID = "1-0-rK8a0_GEK4zXUcNmvkb0pnXIK4To2SnzW2rErglo"
SHEET_URL = f"https://docs.google.com/spreadsheets/d/{SHEET_ID}/gviz/tq?tqx=out:csv"

@st.cache_data
def load_data():
    df = pd.read_csv(SHEET_URL)
    return df

try:
    df = load_data()
except Exception as e:
    st.error(f"λ°μ΄ν„° λ΅λ“ μ‹¤ν¨: {e}")
    st.stop()

# 3. λ¨λΈ μ„¤μ •
model = genai.GenerativeModel("gemini-2.0-flash-exp")

# --- 4. μ‚¬μ΄λ“λ°”: 5λ‹¨κ³„ μ •λ°€ μ·¨ν–¥ μ„ νƒμ°½ ---
st.sidebar.header("π― μ†λ―λ¦¬μ—μ λ§μ¶¤ ν•„ν„°")

# κ°€κ²© μΉ΄ν…κ³ λ¦¬
price_option = st.sidebar.selectbox(
    "π’µ μ–΄λ μ •λ„ κ°€κ²©λ€λ¥Ό μƒκ°ν•μ‹λ‚μ”?",
    ["μ „μ²΄ κ°€κ²©λ€", "κ°€μ„±λΉ„ λ°μΌλ¦¬ (3λ§μ› μ΄ν•)", "λ¶€λ‹΄ μ—†λ” μ„ λ¬Ό/λ¨μ„ (3~7λ§μ›)", "νΉλ³„ν• λ‚ μ μ£ΌμΈκ³µ (7~15λ§μ›)", "ν”„λ¦¬λ―Έμ—„ μ½λ ‰μ… (15λ§μ› μ΄μƒ)"]
)

st.sidebar.markdown("---")
st.sidebar.subheader("π‘… μ„ νΈν•λ” λ§› (5λ‹¨κ³„)")

# 5λ‹¨κ³„ μ •λ°€ μ¬λΌμ΄λ” μ„¤μ •
body = st.sidebar.select_slider(
    "λ°”λ””κ° (λ¬΄κ²κ°)", 
    options=["λ§¤μ° κ°€λ²Όμ›€", "κ°€λ²Όμ›€", "μ¤‘κ°„", "μ•½κ°„ λ¬΄κ±°μ›€", "λ§¤μ° μ§„ν•κ³  λ¬΄κ±°μ›€"]
)

sweet = st.sidebar.select_slider(
    "λ‹Ήλ„ (λ‹¬μ½¤ν•¨)", 
    options=["λ§¤μ° λ“λΌμ΄", "λ“λΌμ΄", "μ¤‘κ°„", "μ•½κ°„ λ‹¬μ½¤ν•¨", "λ§¤μ° λ‹¬μ½¤ν•¨"]
)

acidity = st.sidebar.select_slider(
    "μ‚°λ„ (μƒμ½¤ν•¨)", 
    options=["λ‚®μ", "μ•½κ°„ λ‚®μ", "μ¤‘κ°„", "μ•½κ°„ λ†’μ", "λ§¤μ° λ†’μ(μƒλ™κ°)"]
)

tannin = st.sidebar.select_slider(
    "νƒ€λ‹ (λ–«μ€λ§›)", 
    options=["κ±°μ μ—†μ(λ§¤λ„λ¬μ›€)", "λ¶€λ“λ¬μ›€", "μ¤‘κ°„", "μ•½κ°„ κ°•ν•¨", "κ°•ν•¨(λ‹¨λ‹¨ν•¨)"]
)

# --- 5. λ©”μΈ UI ---
st.title("π· μ™€μΈκ³³κ°„ AI μμ„ μ†λ―λ¦¬μ—")
st.markdown("---")
st.write("μ‚¬μ¥λ‹μ μ„Έλ°€ν• μ·¨ν–¥μ„ μ™Όμ½μ—μ„ μ„ νƒν•μ‹κ±°λ‚, μ¶”κ°€ μ”μ²­μ‚¬ν•­μ„ μ•„λμ— μ μ–΄μ£Όμ„Έμ”.")

query = st.text_input("π’¬ μ¶”κ°€ μ”μ²­μ‚¬ν•­ (μ: μ¤λ μ—°μ–΄ μ¤ν…μ΄ν¬λ‘ λ¨Ήμ„ κ±°μμ”)", "")

if st.button("μ „λ¬Έ μ†λ―λ¦¬μ—μ μ¶”μ² λ°›κΈ°"):
    with st.spinner("μ‚¬μ¥λ‹μ μ •λ°€ν• μ·¨ν–¥κ³Ό μ¬κ³ λ¥Ό λ§¤μΉ­ μ¤‘μ…λ‹λ‹¤..."):
        # λ°μ΄ν„° ν¨μ¨μ„ μ„ν•΄ μƒμ„ 100κ°λ§ μ „λ‹¬
        inventory_sample = df.head(100).to_string(index=False)
        
        prompt = f"""λ„λ” 20λ…„ κ²½λ ¥μ λ§μ¤ν„° μ†λ―λ¦¬μ—μ•Ό. μ•„λ 5λ‹¨κ³„ μ •λ°€ μ·¨ν–¥ μ΅°κ±΄μ„ λ°”νƒ•μΌλ΅ μ°λ¦¬ λ§¤μ¥ μ¬κ³ μ—μ„ μµμ μ μ™€μΈ 3κ°€μ§€λ¥Ό μ—„μ„ ν•΄μ¤.

[λ§¤μ¥ μ¬κ³  λ°μ΄ν„°]
{inventory_sample}

[κ³ κ°μ μ •λ°€ μ„ νƒ μ΅°κ±΄]
- κ°€κ²©λ€: {price_option}
- λ°”λ””κ°: {body} (5λ‹¨κ³„ μ¤‘ μ„ νƒλ¨)
- λ‹Ήλ„: {sweet} (5λ‹¨κ³„ μ¤‘ μ„ νƒλ¨)
- μ‚°λ„: {acidity} (5λ‹¨κ³„ μ¤‘ μ„ νƒλ¨)
- νƒ€λ‹: {tannin} (5λ‹¨κ³„ μ¤‘ μ„ νƒλ¨)
- κ³ κ° μ¶”κ°€ μ”μ²­: {query}

[λ‹µλ³€ κ·μΉ™]
1. νΈν…” μμ„ μ†λ―λ¦¬μ—μ κ²©μ‹ μλ” λ§ν¬λ΅ μ‘μ„±ν•  κ²ƒ.
2. κ° μ™€μΈμ 'ν…μ΄μ¤ν… λ…ΈνΈ'λ¥Ό μƒ‰, ν–¥, μ§κ°, μ—¬μ΄μΌλ΅ λ‚λ„μ–΄ μ•„μ£Ό μƒμ„Έν κΈ°μ ν•  κ²ƒ.
3. κ³ κ°μ΄ μ„ νƒν• 5λ‹¨κ³„ μ§€ν‘κ°€ μ΄ μ™€μΈκ³Ό μ–΄λ–»κ² μ™„λ²½ν•κ² μΌμΉν•λ”μ§€ μ „λ¬Έμ μΌλ΅ μ„¤λ…ν•  κ²ƒ.
4. νμ–΄λ§ μ•μ£Όλ” μ¬λ£μ™€ μ΅°λ¦¬λ²•κΉμ§€ λ””ν…μΌν•κ² μ μ•ν•  κ²ƒ.

β¨ **λ§μ¤ν„° μ†λ―λ¦¬μ—μ μ •λ°€ λ§¤μΉ­ μ¶”μ² Top 3**

1οΈβƒ£ **μ™€μΈλ…** (κ°€κ²©)
- **π· μ†λ―λ¦¬μ—μ ν…μ΄μ¤ν… λ…ΈνΈ**: (μƒ‰μƒ, μ²« ν–¥, μ…μ•μ—μ„μ μ§κ°, μ—¬μ΄μ„ μ•„μ£Ό μƒμ„Έν κΈ°μ )
- **β… μ·¨ν–¥ λ§¤μΉ­ ν¬μΈνΈ**: (κ³ κ°μ΄ μ„¤μ •ν• {body}, {sweet} λ“± 5λ‹¨κ³„ μ§€ν‘μ™€μ μ •λ°€ν• μΌμΉμ„± μ„¤λ…)
- **π½οΈ λ―Έμ‹ νμ–΄λ§**: (μ¶”μ² μ”λ¦¬μ™€ κ·Έ μ΄μ )
- **π’ μ „λ¬Έ μ„λΉ™ ν**: (μ¨λ„, λ””μΊ”ν… λ“±)

(2, 3λ² μ™€μΈ λ™μΌ λ°λ³µ)

λ§μ§€λ§‰μ— "μ΄ μ •κµν• μ¶”μ²μ΄ μ‚¬μ¥λ‹μ λ―Έμ‹ κ²½ν—μ„ ν•μΈµ λ†’μ—¬λ“λ¦¬κΈΈ λ°”λλ‹λ‹¤. κ¶κΈν•μ‹  μ μ€ μ–Έμ λ“  μ§μ›μ„ λ¶λ¬μ£Όμ„Έμ”. π·"λΌκ³  λ§λ¬΄λ¦¬ν•  κ²ƒ."""

        try:
            response = model.generate_content(prompt)
            st.markdown(response.text)
        except Exception as e:
            st.error(f"μ‘λ‹µ μƒμ„± μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤: {e}")
